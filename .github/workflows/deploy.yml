name: Azure Sandbox Deploy Workflow

on:
  workflow_dispatch:
    inputs:
      DestroyResources:
        description: 'Set true to run destroy stage'
        required: false
        default: 'false'

env:
  ParametersFile: './parameters.json'
  DataFolder: './data'

jobs:
  # -------------------- Stage 1: Create Resource Group --------------------
  create-rg:
    name: Create Resource Group
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run create-rg.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running create-rg.ps1..."
          & "./scripts/create-rg.ps1" -ParametersFile "${{ env.ParametersFile }}"

  # -------------------- Stage 2: Deploy Infrastructure --------------------
  deploy:
    name: Deploy Infrastructure
    runs-on: windows-latest
    needs: create-rg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run deploy.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running deploy.ps1..."
          & "./scripts/deploy.ps1" -ParametersFile "${{ env.ParametersFile }}"

  # -------------------- Stage 3: Post-Deployment Verification --------------------
  post-deploy-verify:
    name: Post-Deploy Verification
    runs-on: windows-latest
    needs: deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run post-deploy-verify.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running post-deploy-verify.ps1..."
          & "./scripts/post-deploy-verify.ps1" -ParametersFile "${{ env.ParametersFile }}"

  # -------------------- Stage 4: Storage Upload --------------------
  storage-upload:
    name: Upload Data to Storage
    runs-on: windows-latest
    needs: post-deploy-verify
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run storage-upload.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running storage-upload.ps1..."
          & "./scripts/storage-upload.ps1" -ParametersFile "${{ env.ParametersFile }}" -DataFolder "${{ env.DataFolder }}"

  # -------------------- Stage 5: Databricks API Flow --------------------
  databricks-job:
    name: Databricks API Flow
    runs-on: windows-latest
    needs: storage-upload
    env:
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run databricks-api-flow.ps1
        shell: pwsh
        env:
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          Write-Host "ðŸš€ Running databricks-api-flow.ps1..."
          & "./scripts/databricks-api-flow.ps1"

  # -------------------- Stage 6: Destroy Resources (Optional / Manual) --------------------
  destroy:
    name: Destroy Resources
    runs-on: windows-latest
    if: github.event.inputs.DestroyResources == 'true'
    needs: databricks-job
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run destroy.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running destroy.ps1..."
          & "./scripts/destroy.ps1" -ParametersFile "${{ env.ParametersFile }}"
