name: Azure Sandbox Workflow

# Manual trigger only
on:
  workflow_dispatch:
    inputs:
      DestroyResources:
        description: 'Set true to run destroy stage'
        required: false
        default: 'false'

env:
  ParametersFile: './parameters.json'
  DataFolder: './data'

jobs:
  # -------------------- Azure Login --------------------
  azure-login:
    name: Azure Login
    runs-on: windows-latest
    outputs:
      AZURE_LOGGED_IN: ${{ steps.login.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to Azure
        id: login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

  # -------------------- Stage 1: Create Resource Group --------------------
  create-rg:
    name: Create Resource Group
    runs-on: windows-latest
    needs: azure-login
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run create-rg.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running create-rg.ps1..."
          & "./scripts/create-rg.ps1" -ParametersFile "${{ env.ParametersFile }}"

  # -------------------- Stage 2: Deploy Infrastructure --------------------
  deploy-infra:
    name: Deploy Infrastructure
    runs-on: windows-latest
    needs: create-rg
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run deploy.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running deploy.ps1..."
          & "./scripts/deploy.ps1" -ParametersFile "${{ env.ParametersFile }}"

  # -------------------- Stage 3: Post-Deploy Verification --------------------
  post-deploy-verify:
    name: Post-Deploy Verification
    runs-on: windows-latest
    needs: deploy-infra
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run post-deploy-verify.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running post-deploy-verify.ps1..."
          & "./scripts/post-deploy-verify.ps1" -ParametersFile "${{ env.ParametersFile }}"

  # -------------------- Stage 4: Storage Upload --------------------
  storage-upload:
    name: Storage Upload
    runs-on: windows-latest
    needs: post-deploy-verify
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run storage-upload.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running storage-upload.ps1..."
          & "./scripts/storage-upload.ps1" -ParametersFile "${{ env.ParametersFile }}" -DataFolder "${{ env.DataFolder }}"

  # -------------------- Stage 5: Optional Destroy --------------------
  destroy:
    name: Destroy Resources (Optional)
    runs-on: windows-latest
    needs: storage-upload
    if: ${{ github.event.inputs.DestroyResources == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run destroy.ps1
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Running destroy.ps1..."
          & "./scripts/destroy.ps1" -ParametersFile "${{ env.ParametersFile }}"
